<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/index.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/index.js~KarmaBot.html">KarmaBot</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/index.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/* @flow */
import KarmaStore from &apos;karma-store-redis&apos;

type Controller = {
  hears: Function
}

/**
 * number formatter
 * @param  {String} data - number of string
 * @param  {Number} [length=2] - max digits, ex. 2 when 99
 * @return {string} 099 when length 3 data 99
 */
function format (data: string, length = 2): string {
  if (data.length === length) {
    return data
  }

  if (data.length &lt; length) {
    length -= data.length
    for (let i = 0; i &lt; length; i++) {
      data = &apos;0&apos; + data
    }
  }
  return data
}

function formatRank (firstMsg: string, data: string[]): string[] {
  const response = [firstMsg]
  for (let i = 0; i &lt; data.length; i += 2) {
    response.push(
      `${format((i / 2 + 1).toString())}. ${data[i]}: ${data[i + 1]}`
    )
  }
  return response
}

export default class KarmaBot {
  _store: KarmaStore
  _ctrl: Controller
  constructor (ctrl: Controller, storeName: string = &apos;karmastore&apos;) {
    this._ctrl = ctrl
    this._store = new KarmaStore(storeName)
  }
  /**
   * karma wrapper
   * @param {String} thing default
   * @returns {String} return default, please override this method
   */
  thingWrapper (thing: string): string {
    return thing
  }
  /**
   * hears ++ things
   * @returns {void}
   */
  plus (): void {
    this._ctrl.hears([&apos;([^+\\s])\\+\\+(\\s|$)&apos;], [&apos;ambient&apos;], (bot, msg) =&gt; {
      const thing = this.thingWrapper(
        msg.text.match(/(\S+[^+\s])\+\+(\s|$)/)[1].toLowerCase()
      )
      const n = 1
      this._store.up(thing, n, karma =&gt; {
        bot.reply(msg, `level up! ${thing}: +${n} (Karma: ${karma})`)
      })
    })
  }
  /**
   * hears -- things
   * @return {void}
   */
  minus (): void {
    // eslint-disable-next-line no-useless-escape
    this._ctrl.hears([&apos;([^-\s])--(\s|$)&apos;], [&apos;ambient&apos;], (bot, msg) =&gt; {
      const thing = this.thingWrapper(
        msg.text.match(/(\S+[^-\s])--(\s|$)/)[1].toLowerCase()
      )
      const n = 1
      this._store.down(thing, n, karma =&gt; {
        bot.reply(msg, `oops! ${thing}: -${n} (Karma: ${karma})`)
      })
    })
  }
  /**
   * show stored karma top best
   * @param {number} cnt show count
   * @return {void}
   */
  showTop (cnt: number = 5): void {
    this._ctrl.hears(
      &apos;karma best&apos;,
      [&apos;direct_mention&apos;, &apos;mention&apos;],
      (bot, msg) =&gt; {
        this._store.top(cnt, (top: string[]) =&gt; {
          bot.reply(msg, formatRank(`The Best:`, top).join(&apos;\n&apos;))
        })
      }
    )
  }
  /**
   * show sorted karma worst
   * @param {number} cnt show count
   * @return {void}
   */
  showWorst (cnt: number = 5): void {
    this._ctrl.hears(
      &apos;karma worst&apos;,
      [&apos;direct_mention&apos;, &apos;mention&apos;],
      (bot, msg) =&gt; {
        this._store.lowest(cnt, (worst: string[]) =&gt; {
          bot.reply(msg, formatRank(`The Worst:`, worst).join(&apos;\n&apos;))
        })
      }
    )
  }
  /**
   * listen all hears
   * @return {void}
   */
  listen (): void {
    this.plus()
    this.minus()
    this.showTop()
    this.showWorst()
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
